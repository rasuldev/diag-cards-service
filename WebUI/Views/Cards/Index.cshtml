@model WebUI.Models.CardsViewModels.ListCardsViewModel
@{
    ViewData["Title"] = "Список карт";
}
<meta charset="utf-8">
<h2>@ViewData["Title"]</h2>

<p>
    <a asp-action="Create">Добавить новую карту</a>
</p>
@{
    string errorText = (string)TempData["ErrorText"];
    if (errorText != null)
    {
        <div class="alert alert-warning">
            <strong>Внимание!</strong> @TempData["ErrorText"]
        </div>
    }
}

@using (Html.BeginForm(FormMethod.Get))
{
    <div class="form-inline">
        <input asp-for="Filter.Regnumber" placeholder="Регистрационный знак" class="form-control" style="width: 200px" />
        <input asp-for="Filter.Vin" placeholder="VIN" class="form-control" />
        <input asp-for="Filter.Fullname" placeholder="ФИО" class="form-control" />
        <input asp-for="Filter.StartDate" placeholder="Дата создания: от" class="form-control" />
        <input asp-for="Filter.EndDate" placeholder="Дата создания: до" class="form-control" />

        @Html.DropDownList("filter", (SelectList)TempData["CardStatusEnum"], new { @class = "form-control" })

        @{
            if (User.IsInRole(UserRoles.Admin))
            {
                <text>
                @Html.DropDownList("userId", (SelectList)TempData["UsersList"], new { @class = "form-control" })
                </text>
            }
        }

        <button type="submit" class="btn btn-warning">Поиск</button>
    </div>
            }

<form id="register_form" method="post" asp-action="Register">
    <input type="hidden" id="reg_form_card_id" name="id" />
</form>

<table class="table table-striped">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Cards.FirstOrDefault().CreatedDate)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Cards.FirstOrDefault().Fullname)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Cards.FirstOrDefault().VIN)
            </th>
            <th>
                Марка, модель (год)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Cards.FirstOrDefault().Running)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Cards.FirstOrDefault().RegNumber)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Cards.FirstOrDefault().ExpirationDate)
            </th>
            @if (User.IsInRole(UserRoles.Admin))
            {
                <th>
                    Пользователь
                </th>
            }
            <th></th>
        </tr>
    </thead>
    <tbody>

        @foreach (var item in Model.Cards)
            {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.CreatedDate)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Fullname)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.VIN)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Manufacturer)
                    @Html.DisplayFor(modelItem => item.Model) (@Html.DisplayFor(modelItem => item.IssueYear))
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Running)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.RegNumber)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.ExpirationDate)
                </td>
                @if (User.IsInRole(UserRoles.Admin))
                {
                    <td>
                        @Html.DisplayFor(modelItem => item.User.UserName)

                    </td>
                }
                <td class="col-md-1 container actions">
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-primary" title="Изменить">
                        <i class="fa fa-pencil" aria-hidden="true"></i>
                    </a>
                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info" title="Детали">
                        <i class="fa fa-info-circle" aria-hidden="true"></i>
                    </a>
                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger" title="Удалить">
                        <i class="fa fa-times" aria-hidden="true"></i>
                    </a>
                    @{
                        bool isDayLimitReached = (bool)TempData["isDayLimitExhausted"];
                        string isDisabled = isDayLimitReached ? "disabled" : "";
                        <a href=""  data-id="@item.Id" class="btn btn-success @isDisabled btn-register" title="Зарегистрировать">
                            <i class="fa fa-registered" aria-hidden="true"></i>
                        </a>
                    }

                    <style>
                        .action-btn {
                            width: 100%;
                            margin-bottom: 5px;
                        }
                    </style>
                </td>
            </tr>
                        }
    </tbody>

</table>
@Html.PagerLinks(totalCount: Model.TotalCardsCount, pageSize: 10, visiblePagesCount: 10)

<script type="text/javascript">
    $("a.btn-register").on("click", function (e) {
        e.preventDefault();
        $("#reg_form_card_id").val($(this).attr("data-id"));
        $("#register_form").submit();
    })
</script>



